<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anima Beyond Fantasy - Calcul de Critique</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
    <div class="container" x-data="criticalApp()">
        <h1>üíÄ Anima Beyond Fantasy - Coup Critique</h1>

        <div style="max-width: 800px; margin: 20px auto;">
            <div class="combat-panel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="color: white; margin-bottom: 20px;">üìä Calcul du Critique</h2>

                <div class="input-group">
                    <label style="color: white;">D√©fenseur</label>
                    <select x-model="selectedDefenderId" @change="loadDefenderStats()"
                        style="background-color: rgba(255,255,255,0.9);">
                        <option value="">-- S√©lectionner un personnage --</option>
                        <template x-for="char in characters" :key="char.id">
                            <option :value="char.id" x-text="char.name"></option>
                        </template>
                    </select>
                </div>

                <div class="input-group">
                    <label style="color: white;">D√©g√¢ts de base</label>
                    <input type="number" x-model.number="baseDamage" placeholder="Ex: 75" @input="calculateCritical()">
                </div>

                <div class="input-group">
                    <label style="color: white;">
                        Jet de critique (1d100)
                        <span class="dice-icon" @click="rollCriticalDice()" title="Lancer le d√©">üé≤</span>
                    </label>
                    <input type="number" x-model.number="criticalRoll" placeholder="Ex: 50" min="1" max="100"
                        @input="calculateCritical()">
                </div>

                <div class="input-group">
                    <label style="color: white;">R√©sistance physique du d√©fenseur</label>
                    <input type="number" x-model.number="physicalResistance" placeholder="Ex: 50"
                        @input="calculateCritical()">
                </div>

                <div class="input-group">
                    <label style="color: white;">
                        Jet de r√©sistance (1d100)
                        <span class="dice-icon" @click="rollResistanceDice()" title="Lancer le d√©">üé≤</span>
                    </label>
                    <input type="number" x-model.number="resistanceRoll" placeholder="Ex: 75" min="1" max="100"
                        @input="calculateCritical()">
                </div>

                <div class="results show" x-show="criticalResult !== null" style="margin-top: 20px;">
                    <div class="result-item">
                        <span class="result-label">Niveau de critique</span>
                        <span class="result-value">
                            <span style="color: #dc3545; font-weight: bold;" x-text="criticalResult"></span>
                        </span>
                    </div>

                    <!-- Pas de critique si r√©sultat n√©gatif -->
                    <template x-if="criticalResult < 1">
                        <div class="final-result" style="background: #fff3cd; color: #856404; margin-top: 15px;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">‚úì Pas de critique</div>
                            <div>Le d√©fenseur a r√©sist√© au coup critique.</div>
                        </div>
                    </template>

                    <!-- Critique 1-50 -->
                    <template x-if="criticalResult >= 1 && criticalResult <= 50">
                        <div class="final-result" style="background: #fff; margin-top: 15px;">
                            <div style="font-size: 1.8em; margin-bottom: 10px;">‚ö†Ô∏è Critique mineur (1-50)</div>
                            <div style="margin-bottom: 10px;"><strong>Localisation :</strong> Non</div>
                            <div style="margin-bottom: 10px;"><strong>Effet :</strong></div>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                Le personnage re√ßoit un malus √† toutes ses actions √©gal √† sa marge d'√©chec (<span
                                    x-text="criticalResult"></span>).
                                Il r√©cup√®re de ce malus au rythme de 5 points par round.
                            </div>
                        </div>
                    </template>

                    <!-- Critique 51-100 -->
                    <template x-if="criticalResult >= 51 && criticalResult <= 100">
                        <div class="final-result" style="background: #fff; margin-top: 15px;">
                            <div style="font-size: 1.8em; margin-bottom: 10px;">ü©∏ Critique mod√©r√© (51-100)</div>
                            <div style="margin-bottom: 10px;"><strong>Localisation :</strong> Oui</div>
                            <div style="margin-bottom: 15px;"><strong>Effet :</strong></div>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                                Le personnage re√ßoit un malus √† toutes ses actions √©gal √† sa marge d'√©chec (<span
                                    x-text="criticalResult"></span>).
                                Il r√©cup√®re de ce malus au rythme de 5 points par round, jusqu'√† la moiti√© de sa valeur.
                                Il faut localiser la zone d'impact.
                            </div>
                            <div x-show="!selectedLocation">
                                <div style="margin-bottom: 10px; font-weight: 600;">D√©terminer la localisation :</div>
                                <div style="display: grid; gap: 10px;">
                                    <button class="btn btn-primary" @click="showLocationList = !showLocationList">
                                        üìã S√©lectionner manuellement
                                    </button>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" x-model.number="locationRoll" placeholder="R√©sultat d100"
                                            min="1" max="100" style="flex: 1;">
                                        <button class="btn btn-primary" @click="determineLocationFromRoll()">
                                            ‚úì Valider
                                        </button>
                                    </div>
                                    <button class="btn btn-primary" @click="rollLocation()">
                                        üé≤ Lancer 1d100
                                    </button>
                                </div>
                                <div x-show="showLocationList"
                                    style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
                                    <ul style="list-style: none; padding: 0;">
                                        <template x-for="loc in locations" :key="loc.name">
                                            <li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; cursor: pointer;"
                                                @click="selectLocation(loc)">
                                                <span x-text="loc.name"></span> (<span x-text="loc.range"></span>)
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                            <div x-show="selectedLocation"
                                style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: 600; color: #155724;">
                                    üéØ Localisation : <span x-text="selectedLocation"></span>
                                </div>
                                <button class="btn btn-secondary" @click="resetLocation()" style="margin-top: 10px;">
                                    üîÑ Changer la localisation
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Critique 101-150 -->
                    <template x-if="criticalResult >= 101 && criticalResult <= 150">
                        <div class="final-result" style="background: #fff; margin-top: 15px;">
                            <div style="font-size: 1.8em; margin-bottom: 10px;">üíÄ Critique s√©v√®re (101-150)</div>
                            <div style="margin-bottom: 10px;"><strong>Localisation :</strong> Oui</div>
                            <div style="margin-bottom: 15px;"><strong>Effet :</strong></div>
                            <div
                                style="padding: 10px; background: #fff3cd; border-radius: 5px; margin-bottom: 15px; color: #856404;">
                                Le personnage re√ßoit un malus √† toutes ses actions √©gal √† sa marge d'√©chec (<span
                                    x-text="criticalResult"></span>).
                                Il r√©cup√®re de ce malus au rythme de 5 points par round, jusqu'√† la moiti√© de sa valeur.
                                <strong>Si la localisation indique un membre, celui-ci est d√©truit ou amput√© de fa√ßon
                                    irr√©cup√©rable.</strong>
                                <strong>Si le coup touche la t√™te ou le c≈ìur, le personnage meurt.</strong>
                            </div>
                            <div x-show="!selectedLocation">
                                <div style="margin-bottom: 10px; font-weight: 600;">D√©terminer la localisation :</div>
                                <div style="display: grid; gap: 10px;">
                                    <button class="btn btn-primary" @click="showLocationList = !showLocationList">
                                        üìã S√©lectionner manuellement
                                    </button>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" x-model.number="locationRoll" placeholder="R√©sultat d100"
                                            min="1" max="100" style="flex: 1;">
                                        <button class="btn btn-primary" @click="determineLocationFromRoll()">
                                            ‚úì Valider
                                        </button>
                                    </div>
                                    <button class="btn btn-primary" @click="rollLocation()">
                                        üé≤ Lancer 1d100
                                    </button>
                                </div>
                                <div x-show="showLocationList"
                                    style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
                                    <ul style="list-style: none; padding: 0;">
                                        <template x-for="loc in locations" :key="loc.name">
                                            <li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; cursor: pointer;"
                                                @click="selectLocation(loc)">
                                                <span x-text="loc.name"></span> (<span x-text="loc.range"></span>)
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                            <div x-show="selectedLocation"
                                style="margin-top: 15px; padding: 15px; background: #f8d7da; border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: 600; color: #721c24;">
                                    üéØ Localisation : <span x-text="selectedLocation"></span>
                                </div>
                                <button class="btn btn-secondary" @click="resetLocation()" style="margin-top: 10px;">
                                    üîÑ Changer la localisation
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Critique 151+ -->
                    <template x-if="criticalResult >= 151">
                        <div class="final-result" style="background: #000; color: #fff; margin-top: 15px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚ò†Ô∏è Critique mortel (151+)</div>
                            <div style="margin-bottom: 10px;"><strong>Localisation :</strong> Oui</div>
                            <div style="margin-bottom: 15px;"><strong>Effet :</strong></div>
                            <div
                                style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 15px;">
                                Idem que pr√©c√©demment, mais le personnage tombe aussi imm√©diatement dans l'inconscience.
                                <strong>Il meurt dans un nombre de minutes √©gal √† sa Constitution s'il ne re√ßoit pas
                                    d'aide m√©dicale.</strong>
                            </div>
                            <div x-show="!selectedLocation">
                                <div style="margin-bottom: 10px; font-weight: 600;">D√©terminer la localisation :</div>
                                <div style="display: grid; gap: 10px;">
                                    <button class="btn btn-primary" @click="showLocationList = !showLocationList">
                                        üìã S√©lectionner manuellement
                                    </button>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" x-model.number="locationRoll" placeholder="R√©sultat d100"
                                            min="1" max="100" style="flex: 1;">
                                        <button class="btn btn-primary" @click="determineLocationFromRoll()">
                                            ‚úì Valider
                                        </button>
                                    </div>
                                    <button class="btn btn-primary" @click="rollLocation()">
                                        üé≤ Lancer 1d100
                                    </button>
                                </div>
                                <div x-show="showLocationList"
                                    style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
                                    <ul style="list-style: none; padding: 0;">
                                        <template x-for="loc in locations" :key="loc.name">
                                            <li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; cursor: pointer; color: #000;"
                                                @click="selectLocation(loc)">
                                                <span x-text="loc.name"></span> (<span x-text="loc.range"></span>)
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                            <div x-show="selectedLocation"
                                style="margin-top: 15px; padding: 15px; background: #721c24; border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: 600;">
                                    üéØ Localisation : <span x-text="selectedLocation"></span>
                                </div>
                                <button class="btn btn-secondary" @click="resetLocation()" style="margin-top: 10px;">
                                    üîÑ Changer la localisation
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" @click="window.close()" style="width: 100%;">
                        ‚Üê Retour au combat
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function criticalApp() {
            return {
                characters: [],
                selectedDefenderId: '',
                baseDamage: 0,
                criticalRoll: null,
                physicalResistance: 0,
                resistanceRoll: null,
                criticalResult: null,
                locationRoll: null,
                selectedLocation: null,
                showLocationList: false,
                locations: [
                    { name: 'Torse - C√¥tes', range: '1-10', min: 1, max: 10 },
                    { name: 'Torse - √âpaule', range: '11-20', min: 11, max: 20 },
                    { name: 'Torse - Estomac', range: '21-30', min: 21, max: 30 },
                    { name: 'Torse - Reins', range: '31-35', min: 31, max: 35 },
                    { name: 'Torse', range: '36-48', min: 36, max: 48 },
                    { name: 'Torse - C≈ìur', range: '49-50', min: 49, max: 50 },
                    { name: 'Bras droit - Bras', range: '51-54', min: 51, max: 54 },
                    { name: 'Bras droit - Avant-bras', range: '55-58', min: 55, max: 58 },
                    { name: 'Bras droit - Main', range: '59-60', min: 59, max: 60 },
                    { name: 'Bras gauche - Bras', range: '61-64', min: 61, max: 64 },
                    { name: 'Bras gauche - Avant-bras', range: '65-68', min: 65, max: 68 },
                    { name: 'Bras gauche - Main', range: '69-70', min: 69, max: 70 },
                    { name: 'Jambe droite - Cuisse', range: '71-74', min: 71, max: 74 },
                    { name: 'Jambe droite - Tibia', range: '75-78', min: 75, max: 78 },
                    { name: 'Jambe droite - Pied', range: '79-80', min: 79, max: 80 },
                    { name: 'Jambe gauche - Cuisse', range: '81-84', min: 81, max: 84 },
                    { name: 'Jambe gauche - Tibia', range: '85-88', min: 85, max: 88 },
                    { name: 'Jambe gauche - Pied', range: '89-90', min: 89, max: 90 },
                    { name: 'T√™te', range: '91-100', min: 91, max: 100 }
                ],

                init() {
                    // Charger les personnages depuis localStorage
                    const stored = localStorage.getItem('animaCharacters');
                    if (stored) {
                        this.characters = JSON.parse(stored);
                    }

                    // R√©cup√©rer les param√®tres de l'URL (si pr√©sents)
                    const urlParams = new URLSearchParams(window.location.search);
                    const damage = urlParams.get('damage');
                    const defenderName = urlParams.get('defender');
                    const resistance = urlParams.get('resistance');

                    if (damage) {
                        this.baseDamage = parseInt(damage);
                    }

                    if (resistance) {
                        this.physicalResistance = parseInt(resistance);
                    }

                    // Si un nom de d√©fenseur est fourni dans l'URL, essayer de le trouver
                    if (defenderName && defenderName !== '') {
                        const decodedName = decodeURIComponent(defenderName);
                        const defender = this.characters.find(c => c.name === decodedName);
                        if (defender) {
                            // Utiliser setTimeout pour s'assurer qu'Alpine a fini de monter le DOM
                            setTimeout(() => {
                                this.selectedDefenderId = String(defender.id);
                                this.physicalResistance = defender.physicalResistance || 0;
                            }, 0);
                        }
                    }
                },

                loadDefenderStats() {
                    const defender = this.characters.find(c => c.id === this.selectedDefenderId);
                    if (defender) {
                        this.physicalResistance = defender.physicalResistance || 0;
                    }
                },

                rollCriticalDice() {
                    this.criticalRoll = Math.floor(Math.random() * 100) + 1;
                    this.calculateCritical();
                },

                rollResistanceDice() {
                    this.resistanceRoll = Math.floor(Math.random() * 100) + 1;
                    this.calculateCritical();
                },

                calculateCritical() {
                    if (this.criticalRoll && this.resistanceRoll) {
                        this.criticalResult = this.baseDamage + this.criticalRoll - this.physicalResistance - this.resistanceRoll;
                        if (this.criticalResult >= 200) {
                            this.criticalResult = 200 + Math.floor((this.criticalResult - 200) / 2);
                        }
                        // R√©initialiser la localisation si le r√©sultat change
                        this.selectedLocation = null;
                        this.locationRoll = null;
                        this.showLocationList = false;
                    } else {
                        this.criticalResult = null;
                    }
                },

                rollLocation() {
                    this.locationRoll = Math.floor(Math.random() * 100) + 1;
                    this.determineLocationFromRoll();
                },

                determineLocationFromRoll() {
                    if (!this.locationRoll) return;

                    const location = this.locations.find(loc =>
                        this.locationRoll >= loc.min && this.locationRoll <= loc.max
                    );

                    if (location) {
                        this.selectedLocation = location.name;
                        this.showLocationList = false;
                    }
                },

                selectLocation(location) {
                    this.selectedLocation = location.name;
                    this.showLocationList = false;
                },

                resetLocation() {
                    this.selectedLocation = null;
                    this.locationRoll = null;
                    this.showLocationList = false;
                }
            }
        }
    </script>
</body>

</html>